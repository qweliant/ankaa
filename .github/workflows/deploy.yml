name: Deploy
on:
  workflow_run:
    workflows: ["Tests"]
    branches: [main]
    types:
      - completed
permissions:
  contents: read
jobs:
  deploy:
    name: Deploy to EC2
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    concurrency: deploy-group
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸš€ Starting Deployment on EC2..."
            
            # Switch to root user to ensure we have permissions to manage Docker
            sudo su -

            # Navigate to project folder
            cd /home
            
            # Pull latest changes
            docker compose pull 
            
            # Rebuild and restart containers
            # We use --build to ensure code changes are picked up
            docker compose up -d --build
            
            # Optional: Clean up old, unused images to save disk space
            docker image prune -f
            
            echo "âœ… Deployment Complete!"